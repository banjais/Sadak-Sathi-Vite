// This file manages all audio feedback, including Text-to-Speech (TTS) and sound effects.

// --- State for Voice Selection ---
let voices: SpeechSynthesisVoice[] = [];
let audioContext: AudioContext;

// --- Embedded Audio Assets ---
// By embedding sounds as Base64, we keep the app self-contained.
const soundEffects: { [key: string]: string } = {
    donkey: 'data:audio/mpeg;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4LjQ1LjEwMAAAAAAAAAAAAAAA//tAwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWW6vrGvr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr6+vr-//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////LAC+UDAAAAAAADk9LQUFALE2ZgYCAQAEAGs5AAAAIrUjCg/gEAEg/wAAlwEAAAAAAAD/7wAacE5NAAAAAAAAAAAAAAAA/+0DEQCBwW0CgQABAFB4W04AB2k//5gAAAAAAAAAAAABmZgAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAAAGZmAAAA/gETGFtZTMuMTAwVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV//s"-////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////-////////////////////////////////...e,
};

// --- Voice Management ---

// Function to populate the voices array. This is often asynchronous.
const populateVoiceList = () => {
    try {
        if (typeof window.speechSynthesis === 'undefined') {
            console.warn('Speech Synthesis API not supported.');
            return;
        }
        const availableVoices = window.speechSynthesis.getVoices();
        if (availableVoices.length > 0) {
            voices = availableVoices;
        }
    } catch (e) {
        console.error("Could not get synthesis voices.", e);
    }
};

// Populate voices immediately and set up a listener for when they change.
// This is crucial because some browsers load voices asynchronously.
try {
    populateVoiceList();
    if (typeof window.speechSynthesis !== 'undefined' && window.speechSynthesis.onvoiceschanged !== undefined) {
        window.speechSynthesis.onvoiceschanged = populateVoiceList;
    }
} catch (e) {
     console.error("Could not set up onvoiceschanged listener.", e);
}


// --- Text Sanitization for Speech ---

/**
 * Cleans and prepares a string for more natural speech synthesis.
 * - Removes symbols that shouldn't be read aloud.
 * - Replaces abbreviations with full words.
 * @param text The text to sanitize.
 * @param t The translation function.
 * @returns A sanitized, speech-ready string.
 */
const sanitizeTextForSpeech = (text: string, t: (key: string) => string): string => {
    let sanitized = text;

    // Expand common units and abbreviations
    sanitized = sanitized.replace(/km\/h/g, ` ${t('unit_km_per_hour')} `);

    // Remove or replace special characters that are misread by TTS engines
    sanitized = sanitized.replace(/[#*_]/g, ' '); // Replace #, *, _ with a space
    sanitized = sanitized.replace(/[\(\)]/g, '');    // Remove parentheses
    sanitized = sanitized.replace(/-/g, ' ');       // Replace hyphens with spaces (e.g., "One-Lane" -> "One Lane")

    // Normalize whitespace
    sanitized = sanitized.replace(/\s+/g, ' ').trim();

    return sanitized;
};


// --- Core Speech Function ---

/**
 * Speaks a given text using the best available voice for the specified language.
 * @param text The raw text to be spoken.
 * @param lang The language code (e.g., 'en', 'ne').
 * @param t The translation function, required for sanitization.
 */
export const speak = (text: string, lang: string, t: (key: string) => string) => {
    if (!window.speechSynthesis) {
        console.warn('Speech Synthesis API not supported in this browser.');
        return;
    }

    // Sanitize the text *before* creating the utterance
    const cleanText = sanitizeTextForSpeech(text, t);

    // Cancel any previous utterances to prevent them from overlapping
    window.speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(cleanText);
    utterance.lang = lang;
    utterance.rate = 1.1;
    utterance.pitch = 1;

    // --- Advanced Voice Selection Logic ---
    if (voices.length > 0) {
        let selectedVoice = null;
        
        // 1. Try to find a perfect match (e.g., 'ne-NP')
        selectedVoice = voices.find(voice => voice.lang === lang || voice.lang.replace('_', '-') === lang);

        // 2. If not found, try to find a partial match (e.g., 'ne')
        if (!selectedVoice) {
            selectedVoice = voices.find(voice => voice.lang.startsWith(lang));
        }
        
        // 3. Prioritize "Google" or high-quality voices if multiple options exist for the language
        const languageVoices = voices.filter(voice => voice.lang.startsWith(lang));
        const googleVoice = languageVoices.find(voice => voice.name.includes('Google'));
        if (googleVoice) {
            selectedVoice = googleVoice;
        } else if (languageVoices.length > 0) {
             // As a fallback, pick the first available voice for that language
            selectedVoice = languageVoices[0];
        }

        if (selectedVoice) {
            utterance.voice = selectedVoice;
        } else {
            console.warn(`No specific voice found for language: ${lang}. Using browser default.`);
        }
    } else {
        console.warn("Voice list not populated yet. Using browser default voice.");
    }
    
    // Speak the text
    window.speechSynthesis.speak(utterance);
};


// --- Sound Effects ---

/**
 * Plays a pre-defined sound effect.
 * @param effectName The name of the sound effect to play (e.g., 'donkey').
 */
export const playSoundEffect = (effectName: keyof typeof soundEffects) => {
    const soundData = soundEffects[effectName];
    if (!soundData) {
        console.warn(`Sound effect "${effectName}" not found.`);
        return;
    }

    try {
        const audio = new Audio(soundData);
        audio.play().catch(e => console.error("Error playing sound effect:", e));
    } catch (e) {
        console.error('Could not play sound effect.', e);
    }
};
